<style>
  /* Notifikasi custom di bawah petunjuk */
  .absen-notif {
    margin: 18px auto 0 auto;
    max-width: 340px;
    background: #e8f7e2;
    border: 1.5px solid #b2e6b2;
    color: #226622;
    border-radius: 10px;
    padding: 12px 18px 10px 18px;
    font-size: 1.08rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
    display: none;
    align-items: center;
    gap: 10px;
    position: relative;
    animation: fadeInNotif 0.5s;
  }
  .absen-notif.error {
    background: #ffeaea;
    border: 1.5px solid #ffb2b2;
    color: #a22;
  }
  .absen-notif .notif-close {
    position: absolute;
    right: 10px;
    top: 8px;
    background: none;
    border: none;
    color: #888;
    font-size: 1.1em;
    cursor: pointer;
  }
  @keyframes fadeInNotif {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  /* Navbar responsif */
  .navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    padding: 10px 24px;
    border-radius: 0 0 16px 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
    position: relative;
    z-index: 10;
  }
  .navbar-logo {
    font-weight: bold;
    font-size: 1.2rem;
    color: #2d4fd7;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .navbar-menu {
    display: flex;
    gap: 18px;
    align-items: center;
  }
  .navbar-menu a,
  .navbar-menu button {
    color: #222;
    text-decoration: none;
    font-size: 1.08rem;
    font-weight: 500;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 8px;
    transition: background 0.2s;
  }
  .navbar-menu a.active,
  .navbar-menu a:hover,
  .navbar-menu button:hover {
    background: #f0f4ff;
    color: #2d4fd7;
  }
  .navbar-hamburger {
    display: none;
    flex-direction: column;
    justify-content: center;
    width: 36px;
    height: 36px;
    cursor: pointer;
    border: none;
    background: none;
    z-index: 20;
  }
  .navbar-hamburger span {
    display: block;
    height: 4px;
    width: 26px;
    background: #2d4fd7;
    margin: 4px 0;
    border-radius: 2px;
    transition: 0.3s;
  }
  @media (max-width: 900px) {
    .navbar {
      padding: 10px 10px;
    }
    .navbar-menu {
      gap: 10px;
    }
  }
  @media (max-width: 700px) {
    .navbar-menu {
      position: absolute;
      top: 60px;
      right: 0;
      background: #fff;
      flex-direction: column;
      width: 180px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
      border-radius: 0 0 12px 12px;
      padding: 12px 0;
      display: none;
      z-index: 15;
    }
    .navbar-menu.show {
      display: flex;
    }
    .navbar-hamburger {
      display: flex;
    }
  }
  /* Responsif untuk absensi */
  .absensi-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: flex-start;
    gap: 32px;
    margin-top: 24px;
  }
  .camera-section,
  .instructions {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
  }
  .camera-box {
    width: 100%;
    min-width: 0;
    padding: 22px 0;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 500px;
    margin-bottom: 18px;
  }
  #video {
    width: 100%;
    height: auto;
    max-width: 480px;
    min-width: 0;
    background: #000;
    display: block;
    border-radius: 14px;
    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.12);
    aspect-ratio: 4/3;
    object-fit: cover;
  }
  #cameraSelect {
    width: 100%;
    max-width: 400px;
    margin-bottom: 18px;
    padding: 10px 14px;
    border-radius: 8px;
    border: 1px solid #bdbdbd;
    font-size: 1.1rem;
  }
  .absensi-controls {
    display: flex;
    gap: 22px;
    width: 100%;
    justify-content: center;
  }
  .absensi-controls button {
    flex: 1;
    max-width: 180px;
    font-size: 1.1rem;
  }
  .instructions {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    padding: 18px 18px 10px 18px;
    max-width: 100%;
    font-size: 1rem;
  }

  /* Tablet dan layar sedang */
  @media (max-width: 900px) {
    .absensi-container {
      flex-direction: column;
      align-items: stretch;
      gap: 18px;
    }
    .camera-section,
    .instructions {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
    }
    .camera-box {
      max-width: 100vw;
      width: 100%;
      padding: 12px 0;
    }
    #video {
      max-width: 100vw;
      min-width: 0;
      height: auto;
      aspect-ratio: 4/3;
    }
    .absensi-controls {
      flex-direction: column;
      gap: 12px;
    }
    .absensi-controls button {
      max-width: 100%;
    }
  }

  /* HP dan layar kecil */
  @media (max-width: 600px) {
    .container {
      padding: 0 2vw;
    }
    .page-header h1 {
      font-size: 1.1rem;
    }
    .camera-box {
      padding: 6px 0;
      max-width: 100vw;
    }
    .instructions {
      font-size: 0.97rem;
      padding: 8px 4px 4px 4px;
    }
    #video {
      height: 160px;
      max-width: 100vw;
      aspect-ratio: 4/3;
    }
    .absensi-controls button {
      font-size: 0.97rem;
      padding: 10px 0;
    }
    #cameraSelect {
      font-size: 1rem;
      padding: 8px 10px;
    }
    .tips {
      font-size: 0.93em;
    }
  }

  /* Layar sangat kecil */
  @media (max-width: 400px) {
    .page-header h1 {
      font-size: 0.95rem;
    }
    .camera-box,
    .instructions {
      padding: 2px 0;
    }
    #video {
      height: 100px;
      max-width: 100vw;
      aspect-ratio: 4/3;
    }
    .absensi-controls button {
      font-size: 0.93rem;
      padding: 8px 0;
    }
  }
</style>
{% extends "base.html" %} {% block title %}Absensi - Absensi Face Recognition{%
endblock %} {% block content %}

<div class="container" style="margin-top: 16px">
  <div class="page-header" style="text-align: center">
    <h1><i class="fas fa-fingerprint"></i> Absensi Face Recognition</h1>
    <p class="subtitle">
      Lakukan check-in atau check-out dengan face recognition
    </p>
  </div>
  <div
    class="absensi-container"
    style="
      gap: 16px;
      margin-top: 24px;
      align-items: flex-start;
      justify-content: center;
    "
  >
    <div
      class="camera-section"
      style="
        flex: 0 1 420px;
        display: flex;
        flex-direction: column;
        align-items: center;
      "
    >
      <div
        class="camera-box"
        style="
          padding: 18px 0;
          background: #fff;
          border-radius: 16px;
          box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
          display: flex;
          flex-direction: column;
          align-items: center;
          width: 380px;
          max-width: 100%;
          margin-bottom: 8px;
        "
      >
        <label
          for="cameraSelect"
          style="
            font-weight: 600;
            margin-bottom: 10px;
            color: #222;
            font-size: 1.1rem;
          "
          >Pilih Kamera (Webcam/OBS):</label
        >
        <button
          type="button"
          onclick="updateCameraList()"
          class="btn btn-info btn-sm"
          style="margin-bottom: 10px"
        >
          <i class="fas fa-sync"></i> Refresh Daftar Kamera
        </button>
        <select
          id="cameraSelect"
          style="
            width: 100%;
            max-width: 400px;
            margin-bottom: 18px;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #bdbdbd;
            font-size: 1.1rem;
          "
        ></select>
        <div
          style="
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.12);
            background: #222;
          "
        >
          <video
            id="video"
            autoplay
            playsinline
            width="480"
            height="360"
            style="background: #000; display: block"
          ></video>
        </div>
        <canvas id="canvas" style="display: none"></canvas>
        <div id="status-overlay" class="status-overlay"></div>
      </div>
      <div
        class="absensi-controls"
        style="display: flex; gap: 22px; width: 100%; justify-content: center"
      >
        <button
          onclick="doCheckIn()"
          class="btn btn-success btn-lg"
          style="flex: 1; max-width: 180px; font-size: 1.1rem"
        >
          <i class="fas fa-sign-in-alt"></i> Check In
        </button>
        <button
          onclick="doCheckOut()"
          class="btn btn-danger btn-lg"
          style="flex: 1; max-width: 180px; font-size: 1.1rem"
        >
          <i class="fas fa-sign-out-alt"></i> Check Out
        </button>
      </div>
      <div
        id="result-message"
        class="result-message"
        style="margin-top: 16px"
      ></div>
    </div>
    <div
      class="instructions"
      style="
        flex: 0 1 260px;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        padding: 14px 14px 8px 14px;
        max-width: 100%;
        font-size: 0.98rem;
        margin-top: 0;
      "
    >
      <h3 style="margin-top: 0; font-size: 1.1rem">
        <i class="fas fa-info-circle"></i> Petunjuk
      </h3>
      <ul style="padding-left: 18px; margin-bottom: 10px">
        <li><i class="fas fa-check"></i> Hadapkan wajah ke kamera</li>
        <li><i class="fas fa-check"></i> Pastikan pencahayaan cukup</li>
        <li><i class="fas fa-check"></i> Klik Check In/Out</li>
      </ul>
      <div
        class="tips"
        style="
          background: #fffbe6;
          border-radius: 8px;
          padding: 7px 10px;
          margin-top: 8px;
          font-size: 0.97em;
        "
      >
        <b><i class="fas fa-lightbulb"></i> Tips:</b> Jarak ideal 50-100 cm.
      </div>
      <div id="absenNotif" class="absen-notif"></div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}

<script>
  // Navbar hamburger menu toggle
  const hamburger = document.getElementById("navbarHamburger");
  const menu = document.getElementById("navbarMenu");
  hamburger.addEventListener("click", function () {
    menu.classList.toggle("show");
  });
  // Close menu on link click (mobile UX)
  document.querySelectorAll(".navbar-menu a").forEach(function (link) {
    link.addEventListener("click", function () {
      if (window.innerWidth <= 700) menu.classList.remove("show");
    });
  });

  // Notifikasi custom absen
  function showAbsenNotif({ success, message, name }) {
    const notif = document.getElementById("absenNotif");
    notif.innerHTML = `<span>${success ? "✅" : "❌"}</span> <span><b>${name ? name : ""}</b><br>${message}</span><button class='notif-close' onclick='this.parentElement.style.display="none"'>&times;</button>`;
    notif.className = "absen-notif" + (success ? "" : " error");
    notif.style.display = "flex";
    setTimeout(() => {
      notif.style.display = "none";
    }, 6000);
  }
</script>

<script>
  let video = document.getElementById("video");
  let canvas = document.getElementById("canvas");
  let cameraSelect = document.getElementById("cameraSelect");
  let stream = null;

  // Hilangkan SweetAlert, pakai notifikasi custom

  function updateCameraList() {
    navigator.mediaDevices
      .getUserMedia({ video: true })
      .then(function (stream) {
        navigator.mediaDevices.enumerateDevices().then(function (devices) {
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput",
          );
          cameraSelect.innerHTML = "";
          // Tambahkan opsi default
          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.text = "-- Pilih Kamera --";
          cameraSelect.appendChild(defaultOption);
          videoDevices.forEach((device, i) => {
            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Kamera ${i + 1}`;
            cameraSelect.appendChild(option);
          });
          // Pilih kamera pertama secara otomatis jika ada
          if (videoDevices.length > 0) {
            cameraSelect.value = "";
          }
        });
        stream.getTracks().forEach((track) => track.stop());
      })
      .catch(function (err) {
        showAlert(
          "Tidak dapat mengakses kamera: " +
            err +
            "\nPastikan kamera tidak sedang digunakan aplikasi lain.",
          "error",
        );
      });
  }
  window.updateCameraList = updateCameraList;

  function startCamera() {
    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
    }
    const deviceId = cameraSelect.value;
    if (!deviceId) return;
    navigator.mediaDevices
      .getUserMedia({ video: { deviceId: { exact: deviceId } } })
      .then((s) => {
        video.srcObject = s;
        stream = s;
      })
      .catch((err) => {
        console.error("Error accessing camera:", err);
        let msg = "Gagal mengakses kamera!";
        if (err.name === "NotReadableError") {
          msg +=
            "\nKamera sedang digunakan aplikasi lain. Tutup aplikasi lain yang menggunakan kamera.";
        } else if (err.name === "NotAllowedError") {
          msg += "\nIzin akses kamera ditolak.";
        } else {
          msg += "\n" + err.message;
        }
        showAlert(msg, "error");
      });
  }
  cameraSelect.addEventListener("change", startCamera);
  updateCameraList();

  // Fungsi absensi tetap
  function processAttendance(type) {
    const overlay = document.getElementById("status-overlay");
    overlay.textContent = "Mengenali wajah...";
    overlay.style.display = "flex";

    // Ambil gambar dari video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    const imageData = canvas.toDataURL("image/jpeg");

    // Kirim ke backend
    const formData = new FormData();
    formData.append("type", type);
    formData.append("image_data", imageData);

    fetch("/absensi/recognize", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        overlay.style.display = "none";
        // Tampilkan notifikasi custom di bawah petunjuk
        showAbsenNotif({
          success: data.success,
          message: data.message,
          name: data.name || "",
        });
      })
      .catch((error) => {
        overlay.style.display = "none";
        showAbsenNotif({
          success: false,
          message: "Terjadi kesalahan: " + error,
          name: "",
        });
      });
  }
  function doCheckIn() {
    processAttendance("check_in");
  }
  function doCheckOut() {
    processAttendance("check_out");
  }
</script>
{% endblock %}
